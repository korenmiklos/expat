--------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/koren/Google Drive/Research/expat/research_design/talk/output/variables.log
  log type:  text
 opened on:  29 Nov 2018, 17:45:20

. 
. use temp/firm_ceo_panel

. 
. scalar T1 = 1989

. scalar T2 = 2016

. expand T2-T1+1
(2,386,017 observations created)

. bys frame_id manager_id: gen year = _n-1+T1

. 
. tempfile expand

. save `expand', replace
(note: file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//S_00414.000001 not found)
file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//S_00414.000001 saved

. 
. merge m:1 frame_id year using temp/balance-small, nogen keep(match)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                         1,318,613  
    -----------------------------------------

. merge m:1 frame_id year using temp/N_ceos, nogen keep(match)
(note: variable frame_id was str10, now str12 to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                         1,163,712  
    -----------------------------------------

. * drop very large firms
. egen fp_tag = tag(frame_id manager_id ) 

. egen total_CEOs = sum(fp_tag ), by(frame_id )

. tab total_CEOs 

 total_CEOs |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |     46,302        3.98        3.98
          2 |    121,080       10.40       14.38
          3 |    142,980       12.29       26.67
          4 |    131,132       11.27       37.94
          5 |    108,485        9.32       47.26
          6 |     92,376        7.94       55.20
          7 |     81,214        6.98       62.18
          8 |     60,272        5.18       67.36
          9 |     50,643        4.35       71.71
         10 |     44,170        3.80       75.50
         11 |     38,599        3.32       78.82
         12 |     30,768        2.64       81.47
         13 |     25,103        2.16       83.62
         14 |     24,598        2.11       85.74
         15 |     17,655        1.52       87.25
         16 |     15,696        1.35       88.60
         17 |     16,320        1.40       90.00
         18 |     12,726        1.09       91.10
         19 |      9,785        0.84       91.94
         20 |      9,020        0.78       92.71
         21 |      6,699        0.58       93.29
         22 |      6,358        0.55       93.84
         23 |      4,577        0.39       94.23
         24 |      6,792        0.58       94.81
         25 |      4,175        0.36       95.17
         26 |      2,496        0.21       95.39
         27 |      2,970        0.26       95.64
         28 |      1,400        0.12       95.76
         29 |      4,234        0.36       96.13
         30 |      1,020        0.09       96.21
         31 |      4,340        0.37       96.59
         32 |        800        0.07       96.65
         33 |      2,013        0.17       96.83
         34 |      2,108        0.18       97.01
         35 |      1,295        0.11       97.12
         36 |      1,332        0.11       97.23
         37 |        814        0.07       97.30
         38 |      3,116        0.27       97.57
         41 |      1,025        0.09       97.66
         42 |      4,704        0.40       98.06
         43 |      2,236        0.19       98.26
         44 |        880        0.08       98.33
         46 |      2,254        0.19       98.53
         49 |      1,225        0.11       98.63
         51 |      1,173        0.10       98.73
         52 |        780        0.07       98.80
         55 |      1,210        0.10       98.90
         56 |      1,008        0.09       98.99
         64 |      2,240        0.19       99.18
         67 |        268        0.02       99.21
         80 |      1,760        0.15       99.36
         85 |      2,125        0.18       99.54
         87 |      2,175        0.19       99.73
        177 |      3,186        0.27      100.00
------------+-----------------------------------
      Total |  1,163,712      100.00

. 
. drop if total_CEOs>15
(148,335 observations deleted)

. scalar dropped_too_many_CEOs = r(N_drop)

. 
. drop if founder==1
(341,470 observations deleted)

. scalar dropped_founders = r(N_drop)

. 
. codebook frame_id

--------------------------------------------------------------------------------------------------------------------------------
frame_id                                                                                                             (unlabeled)
--------------------------------------------------------------------------------------------------------------------------------

                  type:  string (str12), but longest is str10

         unique values:  16,089                   missing "":  0/673,907

              examples:  "ft10411614"
                         "ft10760729"
                         "ft11183934"
                         "ft12216109"

. 
. drop age_cat

. clonevar age_cat = age

. recode age_cat 20/24=20 25/29=25 30/39=30 40/49=40 50/max=50
(age_cat: 110175 changes made)

. tab age_cat

    age_cat |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      7,579        1.12        1.12
          1 |     25,392        3.77        4.89
          2 |     30,512        4.53        9.42
          3 |     32,982        4.89       14.31
          4 |     33,563        4.98       19.29
          5 |     33,618        4.99       24.28
          6 |     32,857        4.88       29.16
          7 |     32,059        4.76       33.92
          8 |     31,314        4.65       38.56
          9 |     30,475        4.52       43.08
         10 |     29,632        4.40       47.48
         11 |     28,597        4.24       51.73
         12 |     27,585        4.09       55.82
         13 |     26,419        3.92       59.74
         14 |     25,290        3.75       63.49
         15 |     24,319        3.61       67.10
         16 |     23,008        3.41       70.51
         17 |     21,285        3.16       73.67
         18 |     19,750        2.93       76.60
         19 |     18,401        2.73       79.33
         20 |     67,767       10.06       89.39
         25 |     17,901        2.66       92.05
         30 |     14,368        2.13       94.18
         40 |     17,018        2.53       96.70
         50 |     22,216        3.30      100.00
------------+-----------------------------------
      Total |    673,907      100.00

. 
. 
. * time invariant vars
. foreach X of var expat foreign {
  2.         egen first_year_`X' = min(cond(`X'==1,year,.)), by(frame_id)
  3.         egen ever_`X' = max(`X'==1), by(frame_id)
  4. }
(367089 missing values generated)
(401216 missing values generated)

. 
. gen tenure_foreign = year-first_year_foreign
(401,216 missing values generated)

. 
. 
. *foreign visszahúzása expatba, valaha expat-tal, de soha foreign-mal bíró cégek teljes kidobása
. replace foreign=1 if first_year_expat<=year&foreign==0&ever_foreign==1
(44,245 real changes made)

. drop first_year_foreign

. egen first_year_foreign = min(cond(foreign==1,year,.)), by(frame_id)
(401216 missing values generated)

. 
. drop if ever_expat==1 & ever_foreign==0
(85,114 observations deleted)

. scalar dropped_do3_expat_firmyears = r(N_drop)

. 
. * spell relation dummies
. gen byte before = year<enter_year

. gen byte during = year>=enter_year & year<=first_exit_year

. gen byte after = year>first_exit_year

. gen tenure = year-enter_year

. 
. * spell-to-spell transition
. gen byte DD = (lag_expat==0)&(expat==0)

. gen byte DE = (lag_expat==0)&(expat==1)

. gen byte ED = (lag_expat==1)&(expat==0)

. gen byte EE = (lag_expat==1)&(expat==1)

. 
. * newly arriving CEOs
. local T 4

. gen byte domestic = (expat==0)

. foreach X in domestic expat DD DE ED EE {
  2.         gen byte new_`X' = (tenure <=`T') & (tenure>=0) & (`X'==1)
  3.         
.         * new managers at foreign firms
.         gen byte fnew_`X' = new_`X' & foreign==1
  4.         * only include managers joining in years [-1,...) since foreign
.         replace fnew_`X' = 0 if tenure > tenure_foreign+1
  5. 
.         foreach Y of var tenure before during after {
  6.                 gen `Y'_`X' = (`X'==1)*`Y'
  7.         }
  8. }
(2,669 real changes made)
(1,167 real changes made)
(1,119 real changes made)
(444 real changes made)
(638 real changes made)
(469 real changes made)

. gen fold_expat = expat==1 & tenure>`T'

. gen byte new = new_domestic | new_expat

. gen byte fnew = fnew_domestic | fnew_expat

. 
. *foreign_switch interakció létrehozása
. gen byte foreign_new = foreign & new

. 
. 
. ** do stats here
. tempvar tag

. foreach X of var foreign new expat new_expat fnew fnew_expat {
  2.         count if `X'==1
  3.         scalar N_it_`X' = r(N)
  4.         
.         * by firms
.         egen `tag' = tag(frame_id `X')
  5.         count if `X'==1 & `tag'==1
  6.         scalar N_i_`X' = r(N)
  7.         drop `tag'
  8. }
  246,451
  4,508
  159,475
  14,122
  132,299
  2,976
  33,998
  2,975
  59,060
  4,060
  32,831
  2,865

. 
. 
. *Firm_tag
. egen firm_tag=tag(frame_id)

. egen firm_person = group(frame_id manager_id)

. 
. *Teljes minta elmentése a kontrollokkal
. compress
  variable year was float now int
  variable emp was long now int
  variable id was float now int
  variable relative_year was float now byte
  variable foreign_infirst was float now byte
  variable industry_year was float now int
  variable ind_year was float now byte
  variable manufacturing was float now byte
  variable age was float now int
  variable N_ceos was long now byte
  variable total_CEOs was float now byte
  variable age_cat was float now byte
  variable first_year_expat was float now int
  variable ever_expat was float now byte
  variable ever_foreign was float now byte
  variable tenure_foreign was float now byte
  variable first_year_foreign was float now int
  variable tenure was float now byte
  variable tenure_domestic was float now byte
  variable before_domestic was float now byte
  variable during_domestic was float now byte
  variable after_domestic was float now byte
  variable tenure_expat was float now byte
  variable before_expat was float now byte
  variable during_expat was float now byte
  variable after_expat was float now byte
  variable tenure_DD was float now byte
  variable before_DD was float now byte
  variable during_DD was float now byte
  variable after_DD was float now byte
  variable tenure_DE was float now byte
  variable before_DE was float now byte
  variable during_DE was float now byte
  variable after_DE was float now byte
  variable tenure_ED was float now byte
  variable before_ED was float now byte
  variable during_ED was float now byte
  variable after_ED was float now byte
  variable tenure_EE was float now byte
  variable before_EE was float now byte
  variable during_EE was float now byte
  variable after_EE was float now byte
  variable fold_expat was float now byte
  variable jetok was double now long
  variable export was double now long
  variable ranyag was double now long
  variable wbill was double now long
  variable sales was double now long
  variable final_netgep was double now long
  variable frame_id was str12 now str10
  (87,141,364 bytes saved)

. save temp/analysis_sample, replace
file temp/analysis_sample.dta saved

. save_all_to_json

. log close
      name:  <unnamed>
       log:  /Users/koren/Google Drive/Research/expat/research_design/talk/output/variables.log
  log type:  text
 closed on:  29 Nov 2018, 17:45:58
--------------------------------------------------------------------------------------------------------------------------------
