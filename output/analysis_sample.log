--------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//output/analysis_sample.log
  log type:  text
 opened on:   8 Jun 2021, 12:23:04

. 
. use "`here'/temp/balance-small-clean.dta"

. drop foreign

. 
. sort frame_id_numeric year

. gen x_before = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(27,389 missing values generated)

. gen hole10_before = (x_before > 10 & x_before != .)

. gen hole2_before = (x_before > 2 & x_before != .)

. gen hole1_before = (x_before > 1 & x_before != .)

. 
. foreach var of varlist hole* {
  2.         tab `var'
  3. }

     hole10 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    364,308       99.99       99.99
          1 |         31        0.01      100.00
------------+-----------------------------------
      Total |    364,339      100.00

hole10_befo |
         re |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    364,308       99.99       99.99
          1 |         31        0.01      100.00
------------+-----------------------------------
      Total |    364,339      100.00

hole2_befor |
          e |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    363,189       99.68       99.68
          1 |      1,150        0.32      100.00
------------+-----------------------------------
      Total |    364,339      100.00

hole1_befor |
          e |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    360,144       98.85       98.85
          1 |      4,195        1.15      100.00
------------+-----------------------------------
      Total |    364,339      100.00

. 
. drop x_before hole*

. 
. merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(match) nogen

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           307,760  
    -----------------------------------------

. *merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(1 3) //nogen
. *merge 1:1 frame_id year using "`here'/temp/firm_events.dta"
. 
. sort frame_id_numeric year

. gen x_after = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(25,405 missing values generated)

. gen hole10_after_m = (x_after > 10 & x_after != .)

. gen hole2_after_m = (x_after > 2 & x_after != .)

. gen hole1_after_m = (x_after > 1 & x_after != .)

. 
. foreach var of varlist hole* {
  2.         tab `var'
  3. }

  (firstnm) |
hole10_bala |
        nce |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    307,733       99.99       99.99
          1 |         27        0.01      100.00
------------+-----------------------------------
      Total |    307,760      100.00

  (firstnm) |
hole10_bala |
        nce |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     28,460      100.00      100.00
          1 |          1        0.00      100.00
------------+-----------------------------------
      Total |     28,461      100.00

hole10_afte |
        r_m |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    307,716       99.99       99.99
          1 |         44        0.01      100.00
------------+-----------------------------------
      Total |    307,760      100.00

hole2_after |
         _m |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    306,594       99.62       99.62
          1 |      1,166        0.38      100.00
------------+-----------------------------------
      Total |    307,760      100.00

hole1_after |
         _m |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    303,959       98.76       98.76
          1 |      3,801        1.24      100.00
------------+-----------------------------------
      Total |    307,760      100.00

. 
. *tab _merge
. 
. drop x_after hole*

. 
. preserve

. use "`here'/temp/balance-small-clean.dta", clear

. drop foreign

. merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(1 3)

    Result                           # of obs.
    -----------------------------------------
    not matched                        56,579
        from master                    56,579  (_merge==1)
        from using                          0  (_merge==2)

    matched                           307,760  (_merge==3)
    -----------------------------------------

. sort frame_id_numeric year

. gen x_after = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(27,389 missing values generated)

. gen hole10_after_mm = (x_after > 10 & x_after != .)

. gen hole2_after_mm = (x_after > 2 & x_after != .)

. gen hole1_after_mm = (x_after > 1 & x_after != .)

. 
. foreach var of varlist hole* {
  2.         tab `var'
  3. }

     hole10 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    364,308       99.99       99.99
          1 |         31        0.01      100.00
------------+-----------------------------------
      Total |    364,339      100.00

  (firstnm) |
hole10_bala |
        nce |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    307,733       99.99       99.99
          1 |         27        0.01      100.00
------------+-----------------------------------
      Total |    307,760      100.00

  (firstnm) |
hole10_bala |
        nce |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     28,460      100.00      100.00
          1 |          1        0.00      100.00
------------+-----------------------------------
      Total |     28,461      100.00

hole10_afte |
       r_mm |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    364,308       99.99       99.99
          1 |         31        0.01      100.00
------------+-----------------------------------
      Total |    364,339      100.00

hole2_after |
        _mm |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    363,189       99.68       99.68
          1 |      1,150        0.32      100.00
------------+-----------------------------------
      Total |    364,339      100.00

hole1_after |
        _mm |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    360,144       98.85       98.85
          1 |      4,195        1.15      100.00
------------+-----------------------------------
      Total |    364,339      100.00

. drop x_after hole*

. restore

. 
. preserve

. use "`here'/temp/balance-small-clean.dta", clear

. merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(2 3)

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,056
        from master                         0  (_merge==1)
        from using                      2,056  (_merge==2)

    matched                           307,760  (_merge==3)
    -----------------------------------------

. sort frame_id_numeric year

. gen x_after = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(25,405 missing values generated)

. gen hole10_after_um = (x_after > 10 & x_after != .)

. gen hole2_after_um = (x_after > 2 & x_after != .)

. gen hole1_after_um = (x_after > 1 & x_after != .)

. 
. foreach var of varlist hole* {
  2.         tab `var'
  3. }

     hole10 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    307,733       99.99       99.99
          1 |         27        0.01      100.00
------------+-----------------------------------
      Total |    307,760      100.00

  (firstnm) |
hole10_bala |
        nce |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    309,789       99.99       99.99
          1 |         27        0.01      100.00
------------+-----------------------------------
      Total |    309,816      100.00

  (firstnm) |
hole10_bala |
        nce |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     28,550      100.00      100.00
          1 |          1        0.00      100.00
------------+-----------------------------------
      Total |     28,551      100.00

hole10_afte |
       r_um |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    309,772       99.99       99.99
          1 |         44        0.01      100.00
------------+-----------------------------------
      Total |    309,816      100.00

hole2_after |
        _um |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    308,650       99.62       99.62
          1 |      1,166        0.38      100.00
------------+-----------------------------------
      Total |    309,816      100.00

hole1_after |
        _um |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    308,071       99.44       99.44
          1 |      1,745        0.56      100.00
------------+-----------------------------------
      Total |    309,816      100.00

. drop x_after hole*

. restore

. 
. * not so elegant
. merge m:1 frame_id_numeric year using "`here'/temp/ever_foreign.dta", keepusing(ever_foreign) keep(1 3) gen(filter)

    Result                           # of obs.
    -----------------------------------------
    not matched                       285,202
        from master                   285,202  (filter==1)
        from using                          0  (filter==2)

    matched                            22,558  (filter==3)
    -----------------------------------------

. drop ever_foreign

. 
. rename foreign_ceo foreign

. rename ever_foreign_ceo ever_foreign

. drop foreign_nceo ever_foreign_nceo

. 
. do "`here'/code/create/calc_hole.do"

. cap drop hole* x

. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(25,405 missing values generated)

. forval i = 1(1)10 {
  2.         gen hole`i' = (x > `i' & x != .)
  3. }

. 
end of do-file

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole*, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2     hole3     hole4     hole5
---------+--------------------------------------------------------------------------------------------------------------------------------------------
     sum |     31184      1206      1388      1699      2139      2873      2736      2548    307760      3801      1166       669       433       269
------------------------------------------------------------------------------------------------------------------------------------------------------

   stats |     hole6     hole7     hole8     hole9    hole10
---------+--------------------------------------------------
     sum |       178       133        96        68        44
------------------------------------------------------------

. mat total = r(StatTotal)

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole* if filter == 3, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2     hole3     hole4     hole5
---------+--------------------------------------------------------------------------------------------------------------------------------------------
     sum |     12432      1043      1187      1443      1550      1354      1119       944     22558       373       122        75        48        30
------------------------------------------------------------------------------------------------------------------------------------------------------

   stats |     hole6     hole7     hole8     hole9    hole10
---------+--------------------------------------------------
     sum |        18        14        11        10         7
------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. *nceo overriden to have zeros
. mvencode *_nceo, mv(0) override
n_found~nceo: 279299 missing values recoded
n_insid~nceo: 279299 missing values recoded
n_outsi~nceo: 279299 missing values recoded
n_expat_nceo: 279299 missing values recoded
n_local_nceo: 279299 missing values recoded
ever_ex~nceo: 279299 missing values recoded
      n_nceo: 279299 missing values recoded
   hire_nceo: 279299 missing values recoded
   fire_nceo: 279299 missing values recoded
hire_ex~nceo: 279299 missing values recoded
fire_ex~nceo: 279299 missing values recoded
ceo_spe~nceo: 279299 missing values recoded
has_exp~nceo: 279299 missing values recoded
has_loc~nceo: 279299 missing values recoded
has_fou~nceo: 279299 missing values recoded
has_ins~nceo: 279299 missing values recoded
has_out~nceo: 279299 missing values recoded

. 
. * many foreign changes deleted
. bys frame_id_numeric (year): gen owner_spell = sum(foreign != foreign[_n-1])

. bys frame_id_numeric (year): egen owner_spell_total = total(foreign != foreign[_n-1])

. 
. drop if owner_spell_total > 3 // FIXME: doublecheck the length of spells
(3,387 observations deleted)

. scalar dropped_too_many_foreign_change = r(N_drop)

. display dropped_too_many_foreign_change
3387

. 
. do "`here'/code/create/calc_hole.do"

. cap drop hole* x

. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(25,234 missing values generated)

. forval i = 1(1)10 {
  2.         gen hole`i' = (x > `i' & x != .)
  3. }

. 
end of do-file

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole*, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2     hole3     hole4     hole5
---------+--------------------------------------------------------------------------------------------------------------------------------------------
     sum |     29543      1130      1296      1571      1991      2707      2568      2382    304373      3749      1151       660       430       266
------------------------------------------------------------------------------------------------------------------------------------------------------

   stats |     hole6     hole7     hole8     hole9    hole10
---------+--------------------------------------------------
     sum |       175       131        95        67        43
------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole* if filter == 3, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2     hole3     hole4     hole5
---------+--------------------------------------------------------------------------------------------------------------------------------------------
     sum |     12432      1043      1187      1443      1550      1354      1119       944     22558       373       122        75        48        30
------------------------------------------------------------------------------------------------------------------------------------------------------

   stats |     hole6     hole7     hole8     hole9    hole10
---------+--------------------------------------------------
     sum |        18        14        11        10         7
------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. * divestiture
. bys frame_id_numeric (year): gen divest = sum(cond(owner_spell != owner_spell[_n-1] & foreign == 0 & _n != 1, 1, 0))

. replace divest = 1 if divest > 0
(0 real changes made)

. 
. * only keep D, D-F owner spells
. bys frame_id_numeric: egen start_as_domestic = max((owner_spell == 1) & (foreign == 0))

. *keep if start_as_domestic & owner_spell <= 2
. keep if start_as_domestic
(18,934 observations deleted)

. keep if owner_spell <= 2
(3,267 observations deleted)

. 
. do "`here'/code/create/calc_hole.do"

. cap drop hole* x

. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(23,717 missing values generated)

. forval i = 1(1)10 {
  2.         gen hole`i' = (x > `i' & x != .)
  3. }

. 
end of do-file

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole*, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2     hole3     hole4     hole5
---------+--------------------------------------------------------------------------------------------------------------------------------------------
     sum |     12432      1130      1276      1522      1582      1354      1121       947    282172      3413      1045       597       381       233
------------------------------------------------------------------------------------------------------------------------------------------------------

   stats |     hole6     hole7     hole8     hole9    hole10
---------+--------------------------------------------------
     sum |       156       119        87        60        40
------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole* if filter == 3, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2     hole3     hole4     hole5
---------+--------------------------------------------------------------------------------------------------------------------------------------------
     sum |     12432      1043      1187      1443      1550      1354      1119       944     22558       373       122        75        48        30
------------------------------------------------------------------------------------------------------------------------------------------------------

   stats |     hole6     hole7     hole8     hole9    hole10
---------+--------------------------------------------------
     sum |        18        14        11        10         7
------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. mat list total

total[6,19]
       foreign  foreign_3  foreign_2  foreign_1   foreign0   foreign1   foreign2   foreign3      count      hole1      hole2      hole3      hole4      hole5
sum      31184       1206       1388       1699       2139       2873       2736       2548     307760       3801       1166        669        433        269
sum      12432       1043       1187       1443       1550       1354       1119        944      22558        373        122         75         48         30
sum      29543       1130       1296       1571       1991       2707       2568       2382     304373       3749       1151        660        430        266
sum      12432       1043       1187       1443       1550       1354       1119        944      22558        373        122         75         48         30
sum      12432       1130       1276       1522       1582       1354       1121        947     282172       3413       1045        597        381        233
sum      12432       1043       1187       1443       1550       1354       1119        944      22558        373        122         75         48         30

         hole6      hole7      hole8      hole9     hole10
sum        178        133         96         68         44
sum         18         14         11         10          7
sum        175        131         95         67         43
sum         18         14         11         10          7
sum        156        119         87         60         40
sum         18         14         11         10          7

. 
. * check foreign end expat numbers
. egen firm_tag = tag(frame_id_numeric)

. 
. count if ever_foreign
  22,558

. count if ever_foreign & firm_tag
  1,588

. count if ever_expat_ceo & firm_tag
  564

. count if ever_expat_nceo & firm_tag
  12

. 
. count if has_expat_nceo == 1
  345

. count if has_expat_nceo == 1 & foreign == 0
  14

. count if has_expat_ceo == 1
  4,214

. count if has_expat_ceo == 1 & foreign == 0 // FIXME - should be 0
  0

. count if ever_expat_nceo == 1 & ever_foreign == 0
  10

. count if ever_expat_ceo == 1 & ever_foreign == 0
  0

. 
. *do "`here'/code/create/event_dummies_firmlevel.do"
. 
. *merge 1:1 originalid year using "input/fo3-owner-names/country_codes.dta", keep(match master) nogen
. * "same country" only applies to expats at foreign firms
. *replace country_same = 0 if (has_expat == 0) | (foreign == 0)
. 
. egen industry_year = group(teaor08_1d year)

. *egen last_before_acquisition = max(cond(time_foreign<0, time_foreign, .)), by(originalid)
. *egen ever_same_country = max(country_same), by(originalid)
. 
. *do "`here'/code/create/countries.do"
. 
. *for descriptives (number of firms and firm-years in final data)
. codebook frame_id_numeric

--------------------------------------------------------------------------------------------------------------------------------------------------------------
frame_id_numeric                                                                                                                                   (unlabeled)
--------------------------------------------------------------------------------------------------------------------------------------------------------------

                  type:  numeric (long)

                 range:  [10000049,74849574]          units:  1
         unique values:  23,717                   missing .:  0/282,172

                  mean:   1.3e+07
              std. dev:   6.3e+06

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+07   1.0e+07   1.1e+07   1.2e+07   2.1e+07

. count if firm_tag
  23,717

. count
  282,172

. 
. mata : mat_total_analysis = st_matrix("total")

. mata: mata matsave "`here'/temp/matrix-analysis" mat_total_analysis, replace
(saving mat_total_analysis[6,19])
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/matrix-analysis.mmat saved

. 
. count
  282,172

. count if ever_foreign == 1
  22,558

. tab filter ever_foreign

                      |       (firstnm)
                      |   ever_foreign_ceo
               filter |         0          1 |     Total
----------------------+----------------------+----------
      master only (1) |   259,614          0 |   259,614 
          matched (3) |         0     22,558 |    22,558 
----------------------+----------------------+----------
                Total |   259,614     22,558 |   282,172 

. 
. preserve

.         contract time_foreign if ever_foreign == 1

.         gen type = "analysis"

.         save "`here'/temp/event_time_foreign_analysis", replace
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/event_time_foreign_analysis.dta saved

. restore

. 
. preserve

.         contract time_foreign

.         gen type = "analysis-all"

.         save "`here'/temp/event_time_all_analysis", replace
(note: file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/event_time_all_analysis.dta not found)
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/event_time_all_analysis.dta saved

. restore

. 
. drop first_year_foreign time_foreign foreign_* foreign? count x

. 
. bys frame_id_numeric: egen first_year_foreign_new = min(cond(foreign == 1, year,.))
(259,614 missing values generated)

. generate time_foreign_new = year - first_year_foreign_new
(259,614 missing values generated)

. gen foreign0_new = (time_foreign_new == 0)

. count if foreign0_new == 1
  1,588

. drop *new

. 
. **Recompute spell using only hires
. bys frame_id_numeric: egen first_year_firm = min(year)

. tempvar t_hire

. gen `t_hire'=hire_ceo

. replace `t_hire' = 1 if first_year_firm==year 
(23,717 real changes made)

. bys frame_id_numeric: gen ceo_spell_hire=sum(`t_hire')

. 
. ******Foreign-hired ceo***********
. tempvar t_ceo

. bys frame_id_numeric: egen `t_ceo'= max(ceo_spell_hire) if !foreign
(12,432 missing values generated)

. bys frame_id_numeric: egen last_ceo_spell_do = max(`t_ceo')

. gen foreign_hire = (ceo_spell_hire > last_ceo_spell_do)

. replace foreign_hire = . if last_ceo_spell_do == .
(0 real changes made)

. 
. bys frame_id_numeric: egen ever_foreign_hire = max(foreign_hire)

. cap drop `t_hire' `t_ceo'

. 
. compress
  variable minyear was float now int
  variable maxyear was float now int
  variable exporter_5 was float now byte
  variable age was float now int
  variable owner_spell was float now byte
  variable owner_spell_total was float now byte
  variable divest was float now byte
  variable start_as_domestic was float now byte
  variable hole1 was float now byte
  variable hole2 was float now byte
  variable hole3 was float now byte
  variable hole4 was float now byte
  variable hole5 was float now byte
  variable hole6 was float now byte
  variable hole7 was float now byte
  variable hole8 was float now byte
  variable hole9 was float now byte
  variable hole10 was float now byte
  variable industry_year was float now int
  variable first_year_firm was float now int
  variable ceo_spell_hire was float now byte
  variable last_ceo_spell_do was float now byte
  variable foreign_hire was float now byte
  variable ever_foreign_hire was float now byte
  variable jetok was double now long
  variable export was double now long
  variable immat was double now long
  variable final_netgep was double now long
  variable country_all_ceo was str12 now str9
  (24,266,792 bytes saved)

. save "`here'/temp/analysis_sample.dta", replace
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/analysis_sample.dta saved

. log close
      name:  <unnamed>
       log:  /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//output/analysis_sample.log
  log type:  text
 closed on:   8 Jun 2021, 12:23:26
--------------------------------------------------------------------------------------------------------------------------------------------------------------
