--------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//output/analysis_sample.log
  log type:  text
 opened on:  22 Apr 2021, 20:34:38

. 
. use "`here'/temp/balance-small-clean.dta"

. drop foreign

. 
. sort frame_id_numeric year

. gen x_before = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(24,445 missing values generated)

. gen hole2_before = (x_before > 2 & x_before != .)

. gen hole1_before = (x_before > 1 & x_before != .)

. 
. merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(match) nogen

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           275,087  
    -----------------------------------------

. *merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(1 3) //nogen
. *merge 1:1 frame_id year using "`here'/temp/firm_events.dta"
. 
. sort frame_id_numeric year

. gen x_after = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(23,121 missing values generated)

. gen hole2_after = (x_after > 2 & x_after != .)

. gen hole1_after = (x_after > 1 & x_after != .)

. 
. foreach var of varlist hole* {
  2.         tab `var'
  3.         *tab `var' _merge
. }

hole2_befor |
          e |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    274,011       99.61       99.61
          1 |      1,076        0.39      100.00
------------+-----------------------------------
      Total |    275,087      100.00

hole1_befor |
          e |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    271,462       98.68       98.68
          1 |      3,625        1.32      100.00
------------+-----------------------------------
      Total |    275,087      100.00

hole2_after |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    273,124       99.29       99.29
          1 |      1,963        0.71      100.00
------------+-----------------------------------
      Total |    275,087      100.00

hole1_after |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    270,398       98.30       98.30
          1 |      4,689        1.70      100.00
------------+-----------------------------------
      Total |    275,087      100.00

. 
. *tab _merge
. 
. drop x_after x_before hole*

. 
. * not so elegant
. merge m:1 frame_id_numeric year using "`here'/temp/ever_foreign.dta", keepusing(ever_foreign) keep(1 3) gen(filter)

    Result                           # of obs.
    -----------------------------------------
    not matched                       252,790
        from master                   252,790  (filter==1)
        from using                          0  (filter==2)

    matched                            22,297  (filter==3)
    -----------------------------------------

. drop ever_foreign

. 
. rename foreign_ceo foreign

. rename ever_foreign_ceo ever_foreign

. drop foreign_nceo ever_foreign_nceo

. 
. gen count = 1

. 
. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(23,121 missing values generated)

. gen hole2 = (x > 2 & x != .)

. gen hole1 = (x > 1 & x != .)

. 
. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole1 hole2, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2
---------+--------------------------------------------------------------------------------------------------------------
     sum |     17955      1155      1387      1712      2102      1943      1812      1665    275087      4689      1963
------------------------------------------------------------------------------------------------------------------------

. mat total = r(StatTotal)

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole1 hole2 if filter == 3, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2
---------+--------------------------------------------------------------------------------------------------------------
     sum |     10165       958      1119      1363      1404      1228      1112      1004     22297       540       261
------------------------------------------------------------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. *nceo overriden to have zeros
. mvencode *_nceo, mv(0) override
n_found~nceo: 252104 missing values recoded
n_insid~nceo: 252104 missing values recoded
n_outsi~nceo: 252104 missing values recoded
n_expat_nceo: 252104 missing values recoded
n_local_nceo: 252104 missing values recoded
ever_ex~nceo: 252104 missing values recoded
      n_nceo: 252104 missing values recoded
   hire_nceo: 252104 missing values recoded
   fire_nceo: 252104 missing values recoded
hire_ex~nceo: 252104 missing values recoded
fire_ex~nceo: 252104 missing values recoded
ceo_spe~nceo: 252104 missing values recoded
has_exp~nceo: 252104 missing values recoded
has_loc~nceo: 252104 missing values recoded
has_fou~nceo: 252104 missing values recoded
has_ins~nceo: 252104 missing values recoded
has_out~nceo: 252104 missing values recoded

. 
. * many foreign changes deleted
. bys frame_id_numeric (year): gen owner_spell = sum(foreign != foreign[_n-1])

. bys frame_id_numeric (year): egen owner_spell_total = total(foreign != foreign[_n-1])

. 
. drop if owner_spell_total > 3 // FIXME: doublecheck the length of spells
(3,010 observations deleted)

. scalar dropped_too_many_foreign_change = r(N_drop)

. display dropped_too_many_foreign_change
3010

. 
. drop hole* x

. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(22,968 missing values generated)

. gen hole2 = (x > 2 & x != .)

. gen hole1 = (x > 1 & x != .)

. 
. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole1 hole2, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2
---------+--------------------------------------------------------------------------------------------------------------
     sum |     16400      1084      1298      1589      1960      1796      1665      1524    272077      4611      1927
------------------------------------------------------------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole1 hole2 if filter == 3, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2
---------+--------------------------------------------------------------------------------------------------------------
     sum |     10165       958      1119      1363      1404      1228      1112      1004     22297       540       261
------------------------------------------------------------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. * divestiture
. bys frame_id_numeric (year): gen divest = sum(cond(owner_spell != owner_spell[_n-1] & foreign == 0 & _n != 1, 1, 0))

. replace divest = 1 if divest > 0
(0 real changes made)

. 
. * only keep D, D-F owner spells
. bys frame_id_numeric: egen start_as_domestic = max((owner_spell == 1) & (foreign == 0))

. *keep if start_as_domestic & owner_spell <= 2
. keep if start_as_domestic
(7,411 observations deleted)

. keep if owner_spell <= 2
(2,986 observations deleted)

. 
. drop hole* x

. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(22,369 missing values generated)

. gen hole2 = (x > 2 & x != .)

. gen hole1 = (x > 1 & x != .)

. 
. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole1 hole2, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2
---------+--------------------------------------------------------------------------------------------------------------
     sum |     10165      1084      1263      1493      1484      1289      1065       889    261680      4369      1828
------------------------------------------------------------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. tabstat foreign foreign_3 foreign_2 foreign_1 foreign0 foreign1 foreign2 foreign3 count hole1 hole2 if filter == 3, stat(sum) save

   stats |   foreign  forei~_3  forei~_2  forei~_1  foreign0  foreign1  foreign2  foreign3     count     hole1     hole2
---------+--------------------------------------------------------------------------------------------------------------
     sum |     10165       958      1119      1363      1404      1215       997       832     19311       460       221
------------------------------------------------------------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. mat list total

total[6,11]
       foreign  foreign_3  foreign_2  foreign_1   foreign0   foreign1   foreign2   foreign3      count      hole1      hole2
sum      17955       1155       1387       1712       2102       1943       1812       1665     275087       4689       1963
sum      10165        958       1119       1363       1404       1228       1112       1004      22297        540        261
sum      16400       1084       1298       1589       1960       1796       1665       1524     272077       4611       1927
sum      10165        958       1119       1363       1404       1228       1112       1004      22297        540        261
sum      10165       1084       1263       1493       1484       1289       1065        889     261680       4369       1828
sum      10165        958       1119       1363       1404       1215        997        832      19311        460        221

. 
. * check foreign end expat numbers
. egen firm_tag = tag(frame_id_numeric)

. count if ever_foreign & firm_tag
  1,480

. count if ever_expat_ceo & firm_tag
  478

. count if ever_expat_nceo & firm_tag
  9

. 
. count if has_expat_nceo == 1
  174

. count if has_expat_nceo == 1 & foreign == 0
  5

. count if has_expat_ceo == 1
  3,146

. count if has_expat_ceo == 1 & foreign == 0 // FIXME - should be 0
  5

. count if ever_expat_nceo == 1 & ever_foreign == 0
  5

. count if ever_expat_ceo == 1 & ever_foreign == 0
  0

. 
. *do "`here'/code/create/event_dummies_firmlevel.do"
. 
. *merge 1:1 originalid year using "input/fo3-owner-names/country_codes.dta", keep(match master) nogen
. * "same country" only applies to expats at foreign firms
. *replace country_same = 0 if (has_expat == 0) | (foreign == 0)
. 
. egen industry_year = group(teaor08_1d year)

. *egen last_before_acquisition = max(cond(time_foreign<0, time_foreign, .)), by(originalid)
. *egen ever_same_country = max(country_same), by(originalid)
. 
. *do "`here'/code/create/countries.do"
. 
. *for descriptives (number of firms and firm-years in final data)
. codebook frame_id_numeric

--------------------------------------------------------------------------------------------------------------------------------------------------------------
frame_id_numeric                                                                                                                                   (unlabeled)
--------------------------------------------------------------------------------------------------------------------------------------------------------------

                  type:  numeric (long)

                 range:  [10000049,90620052]          units:  1
         unique values:  22,369                   missing .:  0/261,680

                  mean:   1.3e+07
              std. dev:   6.6e+06

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+07   1.0e+07   1.1e+07   1.3e+07   2.2e+07

. count if firm_tag
  22,369

. count
  261,680

. 
. * calculating time_foreign
. count
  261,680

. 
. preserve

. sort frame_id_numeric year

. contract time_foreign

. gen type = "analysis"

. save "`here'/temp/event_time_foreign_analysis.dta", replace
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/event_time_foreign_analysis.dta saved

. restore

. 
. mata : mat_total_analysis = st_matrix("total")

. mata: mata matsave "temp/matrix-analysis" mat_total_analysis, replace
(saving mat_total_analysis[6,11])
file temp/matrix-analysis.mmat saved

. 
. drop first_year_foreign time_foreign foreign_* foreign? count hole* x

. 
. count
  261,680

. 
. compress
  variable exporter_5 was float now byte
  variable minyear was float now int
  variable maxyear was float now int
  variable age was float now int
  variable owner_spell was float now byte
  variable owner_spell_total was float now byte
  variable divest was float now byte
  variable start_as_domestic was float now byte
  variable industry_year was float now int
  variable jetok was double now long
  variable export was double now long
  variable immat was double now long
  variable final_netgep was double now long
  variable ranyag8091_18 was double now long
  (11,252,240 bytes saved)

. save "`here'/temp/analysis_sample.dta", replace
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/analysis_sample.dta saved

. log close
      name:  <unnamed>
       log:  /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//output/analysis_sample.log
  log type:  text
 closed on:  22 Apr 2021, 20:34:51
--------------------------------------------------------------------------------------------------------------------------------------------------------------
