--------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//output/analysis_sample.log
  log type:  text
 opened on:   8 Apr 2021, 14:25:29

. 
. use "`here'/temp/balance-small-clean.dta"

. drop foreign

. 
. sort frame_id_numeric year

. gen x_before = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(28,692 missing values generated)

. gen hole2_before = (x_before > 2 & x_before != .)

. gen hole1_before = (x_before > 1 & x_before != .)

. 
. merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(match) nogen

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           326,659  
    -----------------------------------------

. *merge 1:1 frame_id year using "`here'/temp/firm_events.dta", keep(1 3) //nogen
. *merge 1:1 frame_id year using "`here'/temp/firm_events.dta"
. 
. sort frame_id_numeric year

. gen x_after = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(27,193 missing values generated)

. gen hole2_after = (x_after > 2 & x_after != .)

. gen hole1_after = (x_after > 1 & x_after != .)

. 
. foreach var of varlist hole* {
  2.         tab `var'
  3.         *tab `var' _merge
. }

hole2_befor |
          e |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    325,422       99.62       99.62
          1 |      1,237        0.38      100.00
------------+-----------------------------------
      Total |    326,659      100.00

hole1_befor |
          e |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    322,417       98.70       98.70
          1 |      4,242        1.30      100.00
------------+-----------------------------------
      Total |    326,659      100.00

hole2_after |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    324,409       99.31       99.31
          1 |      2,250        0.69      100.00
------------+-----------------------------------
      Total |    326,659      100.00

hole1_after |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    321,192       98.33       98.33
          1 |      5,467        1.67      100.00
------------+-----------------------------------
      Total |    326,659      100.00

. 
. *tab _merge
. 
. drop x_after x_before hole*

. 
. * not so elegant
. merge m:1 frame_id_numeric year using "`here'/temp/ever_foreign.dta", keepusing(ever_foreign) keep(1 3) gen(filter)

    Result                           # of obs.
    -----------------------------------------
    not matched                       302,649
        from master                   302,649  (filter==1)
        from using                          0  (filter==2)

    matched                            24,010  (filter==3)
    -----------------------------------------

. drop ever_foreign

. 
. rename foreign_ceo foreign

. rename ever_foreign_ceo ever_foreign

. drop foreign_nceo ever_foreign_nceo

. 
. egen first_year_foreign = min(cond(foreign==1, year, .)), by(frame_id_numeric)
(243,388 missing values generated)

. generate time_foreign = year - first_year_foreign
(243,388 missing values generated)

. gen foreign_0 = (time_foreign == 0)

. gen foreign_1 = (time_foreign == 1)

. gen count = 1

. 
. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(27,193 missing values generated)

. gen hole2 = (x > 2 & x != .)

. gen hole1 = (x > 1 & x != .)

. 
. tabstat foreign foreign_0 foreign_1 count hole1 hole2, stat(sum) save

   stats |   foreign  foreig~0  foreig~1     count     hole1     hole2
---------+------------------------------------------------------------
     sum |     61755      6184      5562    326659      5467      2250
----------------------------------------------------------------------

. mat total = r(StatTotal)

. tabstat foreign foreign_0 foreign_1 count hole1 hole2 if filter == 3, stat(sum) save

   stats |   foreign  foreig~0  foreig~1     count     hole1     hole2
---------+------------------------------------------------------------
     sum |     11402      1611      1357     24010       566       270
----------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. *nceo overriden to have zeros
. mvencode *_nceo, mv(0) override
n_found~nceo: 297402 missing values recoded
n_insid~nceo: 297402 missing values recoded
n_outsi~nceo: 297402 missing values recoded
n_expat_nceo: 297402 missing values recoded
n_local_nceo: 297402 missing values recoded
ever_ex~nceo: 297402 missing values recoded
      n_nceo: 297402 missing values recoded
   hire_nceo: 297402 missing values recoded
   fire_nceo: 297402 missing values recoded
hire_ex~nceo: 297402 missing values recoded
fire_ex~nceo: 297402 missing values recoded
ceo_spe~nceo: 297402 missing values recoded
has_exp~nceo: 297402 missing values recoded
has_loc~nceo: 297402 missing values recoded
has_fou~nceo: 297402 missing values recoded
has_ins~nceo: 297402 missing values recoded
has_out~nceo: 297402 missing values recoded

. 
. * many foreign changes deleted
. bys frame_id_numeric (year): gen owner_spell = sum(foreign != foreign[_n-1])

. bys frame_id_numeric (year): egen owner_spell_total = total(foreign != foreign[_n-1])

. 
. drop if owner_spell_total > 3 // FIXME: doublecheck the length of spells
(4,728 observations deleted)

. scalar dropped_too_many_foreign_change = r(N_drop)

. display dropped_too_many_foreign_change
4728

. 
. drop first_year_foreign time_foreign foreign_0 foreign_1

. egen first_year_foreign = min(cond(foreign==1, year, .)), by(frame_id_numeric)
(243,388 missing values generated)

. generate time_foreign = year - first_year_foreign
(243,388 missing values generated)

. gen foreign_0 = (time_foreign == 0)

. gen foreign_1 = (time_foreign == 1)

. 
. drop hole* x

. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(26,946 missing values generated)

. gen hole2 = (x > 2 & x != .)

. gen hole1 = (x > 1 & x != .)

. 
. tabstat foreign foreign_0 foreign_1 count hole1 hole2, stat(sum) save

   stats |   foreign  foreig~0  foreig~1     count     hole1     hole2
---------+------------------------------------------------------------
     sum |     59178      5937      5323    321931      5353      2202
----------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. tabstat foreign foreign_0 foreign_1 count hole1 hole2 if filter == 3, stat(sum) save

   stats |   foreign  foreig~0  foreig~1     count     hole1     hole2
---------+------------------------------------------------------------
     sum |     11402      1611      1357     24010       566       270
----------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. * divestiture
. bys frame_id_numeric (year): gen divest = sum(cond(owner_spell != owner_spell[_n-1] & foreign == 0 & _n != 1, 1, 0))

. replace divest = 1 if divest > 0
(0 real changes made)

. 
. * only keep D, D-F owner spells
. bys frame_id_numeric: egen start_as_domestic = max((owner_spell == 1) & (foreign == 0))

. keep if start_as_domestic & owner_spell <= 2
(57,762 observations deleted)

. 
. drop first_year_foreign time_foreign foreign_0 foreign_1

. egen first_year_foreign = min(cond(foreign==1, year, .)), by(frame_id_numeric)
(243,388 missing values generated)

. generate time_foreign = year - first_year_foreign
(243,388 missing values generated)

. gen foreign_0 = (time_foreign == 0)

. gen foreign_1 = (time_foreign == 1)

. 
. drop hole* x

. sort frame_id_numeric year

. gen x = year - year[_n-1] if frame_id_numeric == frame_id_numeric[_n-1]
(22,620 missing values generated)

. gen hole2 = (x > 2 & x != .)

. gen hole1 = (x > 1 & x != .)

. 
. tabstat foreign foreign_0 foreign_1 count hole1 hole2, stat(sum) save

   stats |   foreign  foreig~0  foreig~1     count     hole1     hole2
---------+------------------------------------------------------------
     sum |     11402      1611      1334    264169      4404      1842
----------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. tabstat foreign foreign_0 foreign_1 count hole1 hole2 if filter == 3, stat(sum) save

   stats |   foreign  foreig~0  foreig~1     count     hole1     hole2
---------+------------------------------------------------------------
     sum |     11402      1611      1334     20781       480       228
----------------------------------------------------------------------

. mat total = (total \ r(StatTotal))

. 
. mat list total

total[6,6]
       foreign  foreign_0  foreign_1      count      hole1      hole2
sum      61755       6184       5562     326659       5467       2250
sum      11402       1611       1357      24010        566        270
sum      59178       5937       5323     321931       5353       2202
sum      11402       1611       1357      24010        566        270
sum      11402       1611       1334     264169       4404       1842
sum      11402       1611       1334      20781        480        228

. 
. * check foreign end expat numbers
. egen firm_tag = tag(frame_id_numeric)

. count if ever_foreign & firm_tag
  1,611

. count if ever_expat_ceo & firm_tag
  588

. count if ever_expat_nceo & firm_tag
  13

. 
. count if has_expat_nceo == 1
  181

. count if has_expat_nceo == 1 & foreign == 0
  7

. count if has_expat_ceo == 1
  3,984

. count if has_expat_ceo == 1 & foreign == 0 // FIXME - should be 0
  5

. count if ever_expat_nceo == 1 & ever_foreign == 0
  5

. count if ever_expat_ceo == 1 & ever_foreign == 0
  0

. 
. *do "`here'/code/create/event_dummies_firmlevel.do"
. 
. *merge 1:1 originalid year using "input/fo3-owner-names/country_codes.dta", keep(match master) nogen
. * "same country" only applies to expats at foreign firms
. *replace country_same = 0 if (has_expat == 0) | (foreign == 0)
. 
. egen industry_year = group(teaor08_1d year)

. *egen last_before_acquisition = max(cond(time_foreign<0, time_foreign, .)), by(originalid)
. *egen ever_same_country = max(country_same), by(originalid)
. 
. *do "`here'/code/create/countries.do"
. 
. *for descriptives (number of firms and firm-years in final data)
. codebook frame_id_numeric

--------------------------------------------------------------------------------------------------------------------------------------------------------------
frame_id_numeric                                                                                                                                   (unlabeled)
--------------------------------------------------------------------------------------------------------------------------------------------------------------

                  type:  numeric (long)

                 range:  [10000049,90620052]          units:  1
         unique values:  22,620                   missing .:  0/264,169

                  mean:   1.3e+07
              std. dev:   6.6e+06

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+07   1.0e+07   1.1e+07   1.3e+07   2.2e+07

. count if firm_tag
  22,620

. count
  264,169

. 
. * calculating time_foreign
. count
  264,169

. 
. preserve

. sort frame_id_numeric year

. contract time_foreign

. gen type = "analysis"

. save "`here'/temp/event_time_foreign_analysis.dta", replace
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/event_time_foreign_analysis.dta saved

. restore

. 
. mata : mat_total_analysis = st_matrix("total")

. mata: mata matsave "temp/matrix-analysis" mat_total_analysis, replace
(saving mat_total_analysis[6,6])
file temp/matrix-analysis.mmat saved

. 
. drop time_foreign foreign_0 foreign_1 count hole* x

. 
. count
  264,169

. 
. compress
  variable exporter_5 was float now byte
  variable minyear was float now int
  variable maxyear was float now int
  variable age was float now int
  variable owner_spell was float now byte
  variable owner_spell_total was float now byte
  variable divest was float now byte
  variable start_as_domestic was float now byte
  variable first_year_foreign was float now int
  variable industry_year was float now int
  variable jetok was double now long
  variable export was double now long
  variable immat was double now long
  variable final_netgep was double now long
  variable ranyag8091_18 was double now long
  variable country_all_ceo was str12 now str9
  (12,680,112 bytes saved)

. save "`here'/temp/analysis_sample.dta", replace
file /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//temp/analysis_sample.dta saved

. log close
      name:  <unnamed>
       log:  /srv/sandbox/zavecz/dropbox_encrypted/darthmouth/expat-analysis//output/analysis_sample.log
  log type:  text
 closed on:   8 Apr 2021, 14:25:38
--------------------------------------------------------------------------------------------------------------------------------------------------------------
